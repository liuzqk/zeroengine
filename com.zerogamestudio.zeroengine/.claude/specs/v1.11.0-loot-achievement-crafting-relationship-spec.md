# ZeroEngine v1.11.0 Spec - Loot / Achievement / Crafting / Relationship

## 元信息
- **类型**: 功能开发 (四系统统一规划)
- **优先级**: 高
- **采访日期**: 2026-01-04
- **目标版本**: v1.11.0

---

## 1. 背景

### 问题描述
ZeroEngine 缺少 RPG/模拟类游戏的核心系统：掉落表、成就、合成、好感度。这些系统在大厂标准框架中是必备模块。

### 设计目标
- 通用框架设计，适配多种游戏类型
- 四系统深度联动，但保持松耦合
- 全功能支持，可配置复杂度
- 高性能，避免热路径 GC 分配
- 可视化编辑器，降低配置门槛

---

## 2. 系统概览

```
┌─────────────────────────────────────────────────────────────┐
│                    ZeroEngine v1.11.0                        │
├─────────────┬─────────────┬─────────────┬───────────────────┤
│  LootTable  │ Achievement │  Crafting   │   Relationship    │
│  掉落系统   │  成就系统   │  合成系统   │    好感度系统     │
├─────────────┴─────────────┴─────────────┴───────────────────┤
│                    Integration Layer                         │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │Inventory│ │  Quest  │ │  Buff   │ │  Event  │           │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘           │
└─────────────────────────────────────────────────────────────┘
```

---

## 3. Loot Table 掉落系统

### 3.1 核心需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 权重随机 | Must | 基础加权随机抽取 |
| 保底机制 | Must | 累计概率，N 次未出必出 |
| 分层抽取 | Must | 先抽品质，再抽具体物品 |
| 掉落池嵌套 | Should | LootTable 可引用其他 LootTable |
| 条件掉落 | Should | 根据条件启用/禁用条目 |
| 数量随机 | Must | 支持数量范围 (min-max) |

### 3.2 数据结构

```
LootTableSO (ScriptableObject)
├── TableId: string
├── DisplayName: string
├── DropMode: LootDropMode (Weight/Pity/Layered)
├── Entries: List<LootEntry>
│   ├── EntryType: LootEntryType (Item/Table/Currency)
│   ├── ItemRef: InventoryItemSO (if Item)
│   ├── NestedTable: LootTableSO (if Table)
│   ├── CurrencyType: CurrencyType (if Currency)
│   ├── AmountMin / AmountMax: int
│   ├── Weight: float
│   ├── Conditions: List<LootCondition> [SerializeReference]
│   └── PityData: PityConfig (optional)
├── GuaranteedDrops: List<LootEntry> (必掉物品)
└── MaxDropCount: int (最大掉落数量，0=无限)

LootCondition (abstract, [SerializeReference])
├── LevelCondition (PlayerLevel >= X)
├── QuestCondition (Quest in state)
├── ProbabilityCondition (% chance to enable)
└── CustomCondition (callback)

PityConfig
├── MaxAttempts: int (保底次数)
├── CurrentAttempts: int (当前累计)
└── IncrementPerFail: float (每次失败增加的概率)

LootDropMode (enum)
├── Weight       // 纯权重
├── Pity         // 保底模式
└── Layered      // 分层 (先 Rarity，再 Item)
```

### 3.3 API 设计

```csharp
public class LootTableManager : MonoBehaviour
{
    // 单次抽取
    public List<LootResult> Roll(LootTableSO table, int times = 1);

    // 带上下文抽取 (用于条件判断)
    public List<LootResult> Roll(LootTableSO table, LootContext context);

    // 直接发放到 Inventory
    public void RollAndGrant(LootTableSO table, int times = 1);

    // 保底状态查询
    public int GetPityCount(LootTableSO table, LootEntry entry);
    public void ResetPity(LootTableSO table, LootEntry entry);
}

public struct LootResult
{
    public LootEntryType Type;
    public InventoryItemSO Item;
    public CurrencyType Currency;
    public int Amount;
    public bool WasPityDrop;
}

public struct LootContext
{
    public int PlayerLevel;
    public Dictionary<string, object> CustomData;
}
```

---

## 4. Achievement 成就系统

### 4.1 核心需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 累计条件 | Must | 杀怪 N 只、收集 N 个 |
| 状态条件 | Must | 达到等级、拥有物品 |
| 事件条件 | Must | 首次击杀、触发剧情 |
| 多条件组合 | Must | AND/OR 逻辑 |
| 进度追踪 | Must | 实时进度显示 |
| 分类系统 | Should | 战斗/收集/探索 等分类 |
| 隐藏成就 | Should | 达成前隐藏描述 |
| 奖励发放 | Must | 完成后自动/手动领取 |

### 4.2 数据结构

```
AchievementSO (ScriptableObject)
├── AchievementId: string
├── DisplayName / Description: string
├── Icon: Sprite
├── Category: AchievementCategory (enum)
├── IsHidden: bool
├── Points: int (成就点数)
├── Conditions: List<AchievementCondition> [SerializeReference]
│   ├── RequireAll: bool (true=AND, false=OR)
│   └── Condition[]
├── Rewards: List<AchievementReward> [SerializeReference]
└── Prerequisites: List<AchievementSO> (前置成就)

AchievementCondition (abstract, [SerializeReference])
├── CounterCondition      // 累计类
│   ├── EventId: string   // 监听的事件
│   ├── TargetCount: int
│   └── CurrentCount: int (runtime)
├── StateCondition        // 状态类
│   ├── CheckType: StateCheckType
│   ├── TargetValue: int
│   └── ItemRef: InventoryItemSO (optional)
├── EventCondition        // 事件类
│   ├── EventId: string
│   └── TriggerOnce: bool
└── CompositeCondition    // 组合条件
    ├── Operator: LogicalOp (AND/OR)
    └── SubConditions: List<AchievementCondition>

AchievementReward (abstract, [SerializeReference])
├── ItemReward (Item + Amount)
├── CurrencyReward (Type + Amount)
├── ExpReward (Amount)
├── UnlockReward (解锁内容)
├── BuffReward (永久 Buff)
└── RelationshipReward (好感度)

AchievementCategory (enum)
├── Combat      // 战斗
├── Collection  // 收集
├── Exploration // 探索
├── Social      // 社交
├── Story       // 剧情
└── Hidden      // 隐藏
```

### 4.3 API 设计

```csharp
public class AchievementManager : MonoBehaviour, ISaveable
{
    // 事件处理
    public void ProcessEvent(string eventId, int amount = 1);
    public void ProcessEvent(string eventId, object data);

    // 状态查询
    public AchievementState GetState(AchievementSO achievement);
    public float GetProgress(AchievementSO achievement); // 0-1
    public bool IsUnlocked(AchievementSO achievement);

    // 奖励
    public void ClaimReward(AchievementSO achievement);
    public bool HasUnclaimedReward(AchievementSO achievement);

    // 查询
    public IReadOnlyList<AchievementSO> GetByCategory(AchievementCategory cat);
    public IReadOnlyList<AchievementSO> GetUnlocked();
    public int GetTotalPoints();

    // 事件
    public event Action<AchievementSO> OnAchievementUnlocked;
    public event Action<AchievementSO, float> OnProgressChanged;
    public event Action<AchievementSO> OnRewardClaimed;
}

public enum AchievementState
{
    Locked,      // 前置未满足
    InProgress,  // 进行中
    Completed,   // 已完成未领取
    Claimed      // 已领取
}
```

---

## 5. Crafting 合成系统

### 5.1 核心需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 配方定义 | Must | 材料 → 产出 |
| 配方解锁 | Must | 学习/购买/成就解锁 |
| 材料消耗 | Must | 检查并扣除材料 |
| 随机品质 | Should | 同配方产出不同品质 |
| 失败机制 | Should | 可配置失败率 |
| 批量合成 | Should | 一次合成多个 |
| 合成时间 | Optional | 需要等待时间 |
| 工作台 | Optional | 不同配方需要不同工作台 |

### 5.2 数据结构

```
RecipeSO (ScriptableObject)
├── RecipeId: string
├── DisplayName / Description: string
├── Icon: Sprite
├── Category: RecipeCategory
├── RequiredStation: CraftingStationType (optional)
├── UnlockCondition: RecipeUnlockCondition [SerializeReference]
│   ├── AlwaysUnlocked
│   ├── LearnFromItem (消耗配方书)
│   ├── AchievementUnlock
│   ├── RelationshipUnlock (好感度解锁)
│   └── QuestUnlock
├── Ingredients: List<RecipeIngredient>
│   ├── Item: InventoryItemSO
│   ├── Amount: int
│   └── ConsumeOnFail: bool
├── Outputs: List<RecipeOutput>
│   ├── Item: InventoryItemSO
│   ├── AmountMin / AmountMax: int
│   ├── Chance: float (产出概率)
│   └── QualityRange: RarityRange (optional)
├── CraftTime: float (秒，0=即时)
├── SuccessRate: float (0-1)
├── FailureOutput: List<RecipeOutput> (失败产出)
└── ExpReward: int (合成经验)

RecipeCategory (enum)
├── Weapon
├── Armor
├── Consumable
├── Material
├── Tool
└── Special

CraftingStationType (ScriptableObject)
├── StationId: string
├── DisplayName: string
├── AvailableRecipes: List<RecipeSO>
└── Tier: int (工作台等级)
```

### 5.3 API 设计

```csharp
public class CraftingManager : MonoBehaviour, ISaveable
{
    // 配方状态
    public bool IsUnlocked(RecipeSO recipe);
    public void UnlockRecipe(RecipeSO recipe);
    public bool CanCraft(RecipeSO recipe, int times = 1);

    // 合成操作
    public CraftResult TryCraft(RecipeSO recipe, int times = 1);
    public void StartCraft(RecipeSO recipe, int times = 1); // 异步
    public void CancelCraft();

    // 查询
    public IReadOnlyList<RecipeSO> GetUnlockedRecipes();
    public IReadOnlyList<RecipeSO> GetByCategory(RecipeCategory cat);
    public IReadOnlyList<RecipeSO> GetByStation(CraftingStationType station);
    public int GetCraftCount(RecipeSO recipe); // 历史合成次数

    // 事件
    public event Action<RecipeSO, CraftResult> OnCraftCompleted;
    public event Action<RecipeSO> OnRecipeUnlocked;
    public event Action<RecipeSO, float> OnCraftProgress; // 0-1
}

public struct CraftResult
{
    public bool Success;
    public List<(InventoryItemSO Item, int Amount)> Outputs;
    public ItemRarity? OutputQuality;
}
```

---

## 6. Relationship 好感度系统

### 6.1 核心需求

| 功能 | 优先级 | 说明 |
|------|--------|------|
| 数值管理 | Must | 好感度值增减 |
| 多维度 | Must | 友情/爱情/尊敬 等 |
| 等级阈值 | Must | 好感度→关系等级 |
| 事件触发 | Must | 达到阈值触发事件 |
| 礼物系统 | Should | 送礼影响好感度 |
| 对话影响 | Should | 对话选项影响好感度 |
| 每日上限 | Optional | 每日增加上限 |

### 6.2 数据结构

```
CharacterRelationSO (ScriptableObject)
├── CharacterId: string
├── DisplayName: string
├── Portrait: Sprite
├── Dimensions: List<RelationDimension>
│   ├── DimensionId: string (friendship/love/respect)
│   ├── DisplayName: string
│   ├── MaxValue: int
│   ├── InitialValue: int
│   └── DailyLimit: int (0=无限)
├── Levels: List<RelationLevel>
│   ├── LevelId: string
│   ├── DisplayName: string
│   ├── RequiredValues: Dictionary<string, int> (dimension → value)
│   ├── UnlockRewards: List<RelationReward> [SerializeReference]
│   └── UnlockDialogId: string (optional)
├── GiftPreferences: List<GiftPreference>
│   ├── Item: InventoryItemSO
│   ├── DimensionId: string
│   ├── ValueChange: int
│   └── Reaction: GiftReaction (Love/Like/Neutral/Dislike/Hate)
└── DailyGreeting: DialogGraphSO (optional)

RelationReward (abstract, [SerializeReference])
├── ItemReward
├── RecipeReward (解锁配方)
├── BuffReward
└── CustomReward

GiftReaction (enum)
├── Love     (+大量)
├── Like     (+少量)
├── Neutral  (无变化)
├── Dislike  (-少量)
└── Hate     (-大量)
```

### 6.3 API 设计

```csharp
public class RelationshipManager : MonoBehaviour, ISaveable
{
    // 好感度操作
    public void AddValue(string characterId, string dimension, int amount);
    public int GetValue(string characterId, string dimension);
    public int GetTotalValue(string characterId); // 所有维度总和

    // 等级查询
    public RelationLevel GetLevel(string characterId);
    public RelationLevel GetNextLevel(string characterId);
    public float GetLevelProgress(string characterId); // 0-1

    // 礼物系统
    public GiftReaction GiveGift(string characterId, InventoryItemSO item);
    public GiftReaction PredictGiftReaction(string characterId, InventoryItemSO item);

    // 每日重置
    public void ResetDailyLimits();
    public int GetRemainingDailyLimit(string characterId, string dimension);

    // 事件
    public event Action<string, RelationLevel> OnLevelUp;
    public event Action<string, string, int, int> OnValueChanged; // char, dim, old, new
    public event Action<string, GiftReaction> OnGiftGiven;
}
```

---

## 7. 系统联动设计

### 7.1 联动矩阵

| 源系统 | → Loot | → Achievement | → Crafting | → Relationship |
|--------|--------|---------------|------------|----------------|
| **Loot** | - | 累计掉落成就 | 掉落配方书 | - |
| **Achievement** | 成就解锁掉落表 | - | 成就解锁配方 | 成就奖励好感度 |
| **Crafting** | - | 合成次数成就 | - | 好感度解锁配方 |
| **Relationship** | 好感度影响掉率 | 好感度成就 | 好感度解锁配方 | - |

### 7.2 集成接口

```csharp
// 通用奖励接口
public interface IRewardProvider
{
    void GrantReward(IReward reward, object context);
}

// 通用条件接口
public interface IConditionChecker
{
    bool Check(ICondition condition, object context);
}

// 事件总线集成
public static class GameEvents
{
    // Loot
    public const string LootDropped = "Loot.Dropped";
    public const string RareDropped = "Loot.RareDropped";

    // Achievement
    public const string AchievementUnlocked = "Achievement.Unlocked";

    // Crafting
    public const string ItemCrafted = "Crafting.ItemCrafted";
    public const string RecipeUnlocked = "Crafting.RecipeUnlocked";

    // Relationship
    public const string RelationLevelUp = "Relation.LevelUp";
    public const string GiftGiven = "Relation.GiftGiven";
}
```

---

## 8. 编辑器设计

### 8.1 编辑器列表

| 编辑器 | 功能 |
|--------|------|
| **LootTableEditor** | 掉落表配置、权重预览、模拟抽取 |
| **AchievementEditor** | 成就配置、条件编辑、进度预览 |
| **RecipeEditor** | 配方配置、材料计算、解锁条件 |
| **RelationshipEditor** | 角色配置、好感度曲线、礼物偏好 |

### 8.2 公共功能
- 搜索和筛选
- 批量操作
- 验证检查
- 导入/导出

---

## 9. 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 系统耦合 | 难以单独使用 | 通过接口解耦，可选依赖 |
| 性能问题 | 条件检查开销 | 缓存结果，脏标记模式 |
| 配置复杂 | 策划难以上手 | 可视化编辑器，模板预设 |
| 扩展性 | 难以添加新类型 | [SerializeReference] 多态 |

---

## 10. 实现计划

### Phase 1: Loot Table
1. [ ] LootTableSO 数据结构
2. [ ] LootCondition 多态条件
3. [ ] LootTableManager 核心逻辑
4. [ ] 保底机制实现
5. [ ] LootTableEditor 编辑器

### Phase 2: Achievement
1. [ ] AchievementSO 数据结构
2. [ ] AchievementCondition 多态条件
3. [ ] AchievementReward 多态奖励
4. [ ] AchievementManager + ISaveable
5. [ ] AchievementEditor 编辑器

### Phase 3: Crafting
1. [ ] RecipeSO 数据结构
2. [ ] RecipeUnlockCondition 多态
3. [ ] CraftingManager + ISaveable
4. [ ] 随机品质实现
5. [ ] RecipeEditor 编辑器

### Phase 4: Relationship
1. [ ] CharacterRelationSO 数据结构
2. [ ] RelationReward 多态奖励
3. [ ] RelationshipManager + ISaveable
4. [ ] 礼物系统实现
5. [ ] RelationshipEditor 编辑器

### Phase 5: Integration
1. [ ] 事件总线集成
2. [ ] 跨系统条件/奖励
3. [ ] 统一编辑器入口
4. [ ] CHANGELOG 更新

---

## 11. 验收标准

- [ ] 四系统独立可用
- [ ] 系统间可选联动
- [ ] ISaveable 存档集成
- [ ] 编辑器可配置所有功能
- [ ] 性能：条件检查 < 0.1ms
- [ ] 文档和示例完整

---

*Generated by Interview Skill - 2026-01-04*