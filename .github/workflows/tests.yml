# ZeroEngine 单元测试 CI
# 在每次 Push 和 PR 时运行 EditMode 测试
#
# ⚠️ 前置条件：需要在 GitHub 仓库设置中配置以下 Secrets：
#   - UNITY_LICENSE: Unity 许可证文件内容 (.ulf)
#   - UNITY_EMAIL: Unity 账号邮箱
#   - UNITY_PASSWORD: Unity 账号密码
#
# 获取许可证: https://game.ci/docs/github/activation

name: Unity Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'com.zerogamestudio.zeroengine*/**'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'com.zerogamestudio.zeroengine*/**'
      - '.github/workflows/tests.yml'
  # 允许手动触发
  workflow_dispatch:

# 需要写权限来发布测试报告
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  test:
    name: Run Unity Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ hashFiles('com.zerogamestudio.zeroengine*/package.json') }}
          restore-keys: |
            Library-

      # 使用 GameCI Unity Test Runner
      # 文档: https://game.ci/docs/github/test-runner
      - name: Run EditMode Tests
        uses: game-ci/unity-test-runner@v4
        id: testRunner
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: 2022.3.62f1
          testMode: EditMode
          artifactsPath: TestResults
          checkName: EditMode Test Results
          # 使用 packageMode 测试 UPM 包
          packageMode: true
          # 通过 customParameters 指定测试程序集
          customParameters: -assemblyNames ZeroEngine.Tests.Editor

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Test Results
          path: TestResults
          retention-days: 14

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: '**/TestResults/*.xml'
          check_name: Unity Test Report
          fail_on_failure: true

  # PlayMode 测试 (可选，需要更多资源)
  # playmode-test:
  #   name: Run PlayMode Tests
  #   runs-on: ubuntu-latest
  #   needs: test
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #     - name: Run PlayMode Tests
  #       uses: game-ci/unity-test-runner@v4
  #       with:
  #         testMode: PlayMode
  #         assemblyNames: ZeroEngine.Tests.Runtime
